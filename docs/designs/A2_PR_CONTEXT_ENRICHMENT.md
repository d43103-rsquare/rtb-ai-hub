# A-2: PR Context Enrichment (PR ë§¥ë½ ìë™ ì²¨ë¶€)

> âœ… **êµ¬í˜„ ì™„ë£Œ** â€” 2026-02-11
>
> **êµ¬í˜„ íŒŒì¼**: `pr-description-builder.ts` (ì‹ ê·œ), `jira-auto-dev-multi.ts` (ìˆ˜ì •)
> **í…ŒìŠ¤íŠ¸**: 22ê°œ (`pr-description-builder.test.ts`)
>
> **ìš°ì„ ìˆœìœ„**: Phase A (Quick Win)
> **ë‚œì´ë„**: ë‚®ìŒ â€” ê¸°ì¡´ PR ìƒì„± ë¡œì§ í™•ì¥
> **ì˜ì¡´ì„±**: ì—†ìŒ (ë…ë¦½ êµ¬í˜„ ê°€ëŠ¥)
> **ì˜ˆìƒ ì‘ì—…ëŸ‰**: 1~2ì¼

---

## 1. ëª©í‘œ

AIê°€ ìƒì„±í•˜ëŠ” PRì˜ descriptionì— **Jira ìš”êµ¬ì‚¬í•­, Figma ë””ìì¸ ë§í¬, ì˜í–¥ ë²”ìœ„, ë„ë©”ì¸ ë§¥ë½**ì„ ìë™ìœ¼ë¡œ ì²¨ë¶€í•œë‹¤.
ë¦¬ë·°ì–´ê°€ PR í•˜ë‚˜ë§Œ ë³´ê³ ë„ ì „ì²´ ë§¥ë½ì„ íŒŒì•…í•  ìˆ˜ ìˆê²Œ ë§Œë“ ë‹¤.

## 2. AS-IS â†’ TO-BE

### AS-IS (í˜„ì¬ PR description)

```markdown
## PROJ-123: ë¡œê·¸ì¸ í˜ì´ì§€ êµ¬í˜„

AI-generated implementation for PROJ-123

### Files Changed (12)

- `src/pages/login.tsx` â€” add
- `src/components/login-form.tsx` â€” add
  ...

### CI Status: All checks passed

- lint (1200ms)
- test (3400ms)
- build (5600ms)

---

_Auto-generated by RTB AI Hub (Multi-Agent Pipeline)_
```

### TO-BE (ë§¥ë½ì´ í’ë¶€í•œ PR description)

```markdown
## PROJ-123: ë¡œê·¸ì¸ í˜ì´ì§€ êµ¬í˜„

AI-generated implementation for PROJ-123

### ğŸ“‹ Context

| í•­ëª©    | ë§í¬                                                                         |
| ------- | ---------------------------------------------------------------------------- |
| Jira    | [PROJ-123 â€” ë¡œê·¸ì¸ í˜ì´ì§€ êµ¬í˜„](https://myorg.atlassian.net/browse/PROJ-123) |
| Figma   | [Login Page Frame](https://figma.com/file/abc123?node-id=1:234)              |
| Preview | [http://localhost:5100](http://localhost:5100)                               |

### ğŸ“ Requirements (from Jira)

- ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ ê¸°ë°˜ ë¡œê·¸ì¸
- ì†Œì…œ ë¡œê·¸ì¸ (Google, Kakao)
- ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸° ë§í¬
- "ë¡œê·¸ì¸ ìœ ì§€" ì²´í¬ë°•ìŠ¤

### ğŸ—ï¸ Implementation

- **Approach**: React Hook Form + Zod validation
- **New Components**: LoginForm, SocialLoginButtons, PasswordInput
- **Routes**: `/login` (public), `/login/callback` (OAuth)

### ğŸ“ Files Changed (12)

- `src/pages/login.tsx` â€” add
- `src/components/login-form.tsx` â€” add
  ...

### ğŸ” Impact Analysis

- **New pages**: 1 (login)
- **Modified modules**: auth
- **Existing code changes**: 0 files modified (all new)
- **DB migrations**: None

### ğŸ“š Domain Knowledge (from wiki)

> auth-flow.md: RTB í”„ë¡œì íŠ¸ì—ì„œ ì¸ì¦ì€ JWT ê¸°ë°˜ì´ë©°, refresh tokenì€ httpOnly cookieì— ì €ì¥...

### CI Status: âœ… All checks passed

...

---

_Auto-generated by RTB AI Hub (Multi-Agent Pipeline)_
```

## 3. ìƒì„¸ ì„¤ê³„

### 3.1 PR Description Builder

**ìœ„ì¹˜**: `packages/workflow-engine/src/utils/pr-description-builder.ts` (ì‹ ê·œ)

```typescript
import type { JiraWebhookEvent, Environment } from '@rtb-ai-hub/shared';
import type { FigmaContext } from './figma-context';

type PrDescriptionInput = {
  event: JiraWebhookEvent;
  env: Environment;
  implementation: {
    plan: string;
    files: Array<{ path: string; content: string; action: string }>;
    tests: Array<{ path: string; content: string }>;
    prSuggestion: { title: string; description: string };
  };
  localResults: {
    branchName: string;
    baseBranch: string;
  };
  ciResults: {
    success: boolean;
    steps: Array<{ name: string; durationMs: number; success: boolean }>;
    failedStep?: { name: string; output: string };
  } | null;
  figmaContext: FigmaContext | null;
  domainKnowledge: string | undefined;
  previewUrl: string | undefined;
};

export function buildEnrichedPrDescription(input: PrDescriptionInput): string {
  const sections: string[] = [];

  // 1. Title
  sections.push(`## ${input.event.issueKey}: ${input.event.summary}\n`);
  sections.push(input.implementation.prSuggestion.description);

  // 2. Context Table
  sections.push(buildContextSection(input));

  // 3. Requirements (from Jira description)
  if (input.event.description) {
    sections.push(buildRequirementsSection(input.event.description));
  }

  // 4. Implementation Summary (from agent plan)
  if (input.implementation.plan) {
    sections.push(buildImplementationSection(input.implementation.plan));
  }

  // 5. Files Changed
  sections.push(buildFilesSection(input.implementation));

  // 6. Impact Analysis
  sections.push(buildImpactSection(input.implementation));

  // 7. Domain Knowledge
  if (input.domainKnowledge) {
    sections.push(buildDomainSection(input.domainKnowledge));
  }

  // 8. CI Status
  if (input.ciResults) {
    sections.push(buildCiSection(input.ciResults));
  }

  // 9. Footer
  sections.push('\n---\n*Auto-generated by RTB AI Hub (Multi-Agent Pipeline)*');

  return sections.filter(Boolean).join('\n');
}

function buildContextSection(input: PrDescriptionInput): string {
  const rows: string[] = ['### ğŸ“‹ Context', '| í•­ëª© | ë§í¬ |', '|------|------|'];

  // Jira link
  const jiraHost = process.env.JIRA_HOST;
  if (jiraHost) {
    rows.push(
      `| Jira | [${input.event.issueKey} â€” ${input.event.summary}](https://${jiraHost}/browse/${input.event.issueKey}) |`
    );
  }

  // Figma link
  if (input.figmaContext?.fileUrl) {
    const figmaLabel = input.figmaContext.nodeIds?.length
      ? `Figma (${input.figmaContext.nodeIds.length} frames)`
      : 'Figma';
    rows.push(`| ${figmaLabel} | [Design File](${input.figmaContext.fileUrl}) |`);
  }

  // Preview link
  if (input.previewUrl) {
    rows.push(`| Preview | [${input.previewUrl}](${input.previewUrl}) |`);
  }

  // Branch info
  rows.push(
    `| Branch | \`${input.localResults.branchName}\` â†’ \`${input.localResults.baseBranch}\` |`
  );

  return rows.join('\n');
}

function buildRequirementsSection(description: string): string {
  // Jira descriptionì—ì„œ í•µì‹¬ ìš”êµ¬ì‚¬í•­ ì¶”ì¶œ (ì²« 500ì)
  const trimmed = description.slice(0, 500);
  return `### ğŸ“ Requirements (from Jira)\n${trimmed}${description.length > 500 ? '\n...' : ''}`;
}

function buildImplementationSection(plan: string): string {
  const trimmed = plan.slice(0, 800);
  return `### ğŸ—ï¸ Implementation Plan\n${trimmed}${plan.length > 800 ? '\n...' : ''}`;
}

function buildFilesSection(impl: PrDescriptionInput['implementation']): string {
  const allFiles = [...impl.files, ...impl.tests.map((t) => ({ ...t, action: 'test' }))];
  const lines = allFiles.map((f) => `- \`${f.path}\` â€” ${f.action}`);
  return `### ğŸ“ Files Changed (${allFiles.length})\n${lines.join('\n')}`;
}

function buildImpactSection(impl: PrDescriptionInput['implementation']): string {
  const newFiles = impl.files.filter((f) => f.action === 'add').length;
  const modifiedFiles = impl.files.filter((f) => f.action === 'modify').length;
  const testFiles = impl.tests.length;

  // Extract affected directories
  const dirs = new Set(impl.files.map((f) => f.path.split('/').slice(0, 2).join('/')));

  return [
    '### ğŸ” Impact Analysis',
    `- **New files**: ${newFiles}`,
    `- **Modified files**: ${modifiedFiles}`,
    `- **Test files**: ${testFiles}`,
    `- **Affected areas**: ${[...dirs].join(', ')}`,
  ].join('\n');
}

function buildDomainSection(knowledge: string): string {
  const trimmed = knowledge.slice(0, 500);
  return `### ğŸ“š Domain Knowledge (from wiki)\n> ${trimmed.replace(/\n/g, '\n> ')}${knowledge.length > 500 ? '\n> ...' : ''}`;
}

function buildCiSection(ci: NonNullable<PrDescriptionInput['ciResults']>): string {
  const icon = ci.success ? 'âœ…' : 'âŒ';
  const status = ci.success ? 'All checks passed' : 'Failed';
  const steps = ci.steps.map((s) => `- ${s.success ? 'âœ…' : 'âŒ'} ${s.name} (${s.durationMs}ms)`);

  let section = `### CI Status: ${icon} ${status}\n${steps.join('\n')}`;

  if (!ci.success && ci.failedStep) {
    section += `\n\n\`\`\`\n${ci.failedStep.output.slice(0, 1000)}\n\`\`\``;
  }

  return section;
}
```

### 3.2 ê¸°ì¡´ ì½”ë“œ ë³€ê²½ì 

**`jira-auto-dev-multi.ts`** â€” `createPullRequestWithCiStatus()` í•¨ìˆ˜ì—ì„œ body ìƒì„± ë¡œì§ êµì²´:

```typescript
// AS-IS: ì¸ë¼ì¸ ë¬¸ìì—´ ì¡°í•©
const prResult = await createGitHubPullRequest(env, {
  owner, repo,
  title: implementation.prSuggestion.title,
  body: [
    `## ${event.issueKey}: ${event.summary}\n`,
    implementation.prSuggestion.description,
    ...
  ].join('\n'),
  head: branchName,
  base: baseBranch,
});

// TO-BE: buildEnrichedPrDescription() ì‚¬ìš©
import { buildEnrichedPrDescription } from '../utils/pr-description-builder';

const prBody = buildEnrichedPrDescription({
  event,
  env,
  implementation,
  localResults: { branchName, baseBranch },
  ciResults,
  figmaContext,           // ì´ë¯¸ í•¨ìˆ˜ ìŠ¤ì½”í”„ì— ì¡´ì¬
  domainKnowledge,        // ì´ë¯¸ í•¨ìˆ˜ ìŠ¤ì½”í”„ì— ì¡´ì¬
  previewUrl: previewResult?.preview?.webUrl,
});

const prResult = await createGitHubPullRequest(env, {
  owner, repo,
  title: implementation.prSuggestion.title,
  body: prBody,
  head: branchName,
  base: baseBranch,
});
```

**ì£¼ì˜**: `figmaContext`ì™€ `domainKnowledge`ë¥¼ `createPullRequestWithCiStatus`ê¹Œì§€ ì „ë‹¬í•˜ê¸° ìœ„í•´ í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜ í™•ì¥ í•„ìš”.

### 3.3 ì‹œê·¸ë‹ˆì²˜ ë³€ê²½

```typescript
// AS-IS
async function createPullRequestWithCiStatus(env, event, implementation, localResults, ciResults);

// TO-BE
async function createPullRequestWithCiStatus(
  env,
  event,
  implementation,
  localResults,
  ciResults,
  options?: {
    figmaContext?: FigmaContext | null;
    domainKnowledge?: string;
    previewUrl?: string;
  }
);
```

## 4. êµ¬í˜„ ìˆœì„œ

1. `packages/workflow-engine/src/utils/pr-description-builder.ts` â€” ì‹ ê·œ ìƒì„±
2. `packages/workflow-engine/src/workflows/jira-auto-dev-multi.ts` â€” `createPullRequestWithCiStatus` ì‹œê·¸ë‹ˆì²˜ í™•ì¥ + `buildEnrichedPrDescription` í˜¸ì¶œ
3. í…ŒìŠ¤íŠ¸: `packages/workflow-engine/src/utils/__tests__/pr-description-builder.test.ts`

## 5. í…ŒìŠ¤íŠ¸ ê³„íš

| í…ŒìŠ¤íŠ¸         | ê²€ì¦ ë‚´ìš©                                       |
| -------------- | ----------------------------------------------- |
| ì „ì²´ ì„¹ì…˜ ìƒì„± | ëª¨ë“  ì»¨í…ìŠ¤íŠ¸ê°€ ìˆì„ ë•Œ ì™„ì „í•œ description ìƒì„± |
| ë¶€ë¶„ ì»¨í…ìŠ¤íŠ¸  | Figma, wiki, preview ì—†ì„ ë•Œ í•´ë‹¹ ì„¹ì…˜ ìƒëµ     |
| ê¸´ í…ìŠ¤íŠ¸ ì²˜ë¦¬ | description/planì´ ê¸¸ ë•Œ ì ì ˆí•œ truncation      |
| íŠ¹ìˆ˜ ë¬¸ì      | Markdown íŠ¹ìˆ˜ë¬¸ìê°€ í¬í•¨ëœ ìš”êµ¬ì‚¬í•­ ì²˜ë¦¬        |
| ë§í¬ ìƒì„±      | Jira/Figma/Preview URLì´ ì˜¬ë°”ë¥´ê²Œ ìƒì„±ë˜ëŠ”ì§€    |
