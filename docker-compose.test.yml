version: '3.8'

services:
  postgres:
    image: postgres:17-alpine
    container_name: rtb-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-rtb_ai_hub}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./infrastructure/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - '${POSTGRES_PORT:-5432}:5432'
    networks:
      - rtb-network
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER:-postgres}']
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: rtb-redis
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy noeviction
    volumes:
      - redis-data:/data
    ports:
      - '${REDIS_PORT:-6379}:6379'
    networks:
      - rtb-network
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5

  auth-service:
    build:
      context: .
      dockerfile: ./packages/auth-service/Dockerfile.simple
      cache_from:
        - rtb-ai-hub-auth-service:latest
    container_name: rtb-auth-service
    volumes:
      - pnpm-cache:/root/.local/share/pnpm/store
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      AUTH_SERVICE_PORT: 4001
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: ${POSTGRES_DB:-rtb_ai_hub}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      DEV_MODE: ${DEV_MODE:-true}
      DEV_USER_EMAIL: ${DEV_USER_EMAIL:-dev@example.com}
      DEV_USER_NAME: ${DEV_USER_NAME:-Dev User}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      GOOGLE_REDIRECT_URI: ${GOOGLE_REDIRECT_URI:-http://localhost:4001/auth/google/callback}
      ALLOWED_WORKSPACE_DOMAINS: ${ALLOWED_WORKSPACE_DOMAINS:-}
      JWT_SECRET: ${JWT_SECRET:-dev-jwt-secret-minimum-32-characters-long}
      APP_URL: ${APP_URL:-http://localhost:4001}
      DASHBOARD_URL: ${DASHBOARD_URL:-http://localhost:3000}
    ports:
      - '${AUTH_SERVICE_PORT:-4001}:4001'
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - rtb-network
    healthcheck:
      test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost:4001/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  workflow-engine:
    build:
      context: .
      dockerfile: ./packages/workflow-engine/Dockerfile.simple
      cache_from:
        - rtb-ai-hub-workflow-engine:latest
    container_name: rtb-workflow-engine
    volumes:
      - pnpm-cache:/root/.local/share/pnpm/store
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: ${POSTGRES_DB:-rtb_ai_hub}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      OPENCODE_API_URL: ${OPENCODE_API_URL:-http://opencode:3333}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - rtb-network
    healthcheck:
      test:
        [
          'CMD',
          'node',
          '-e',
          "require('http').get('http://localhost:3001/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  webhook-listener:
    build:
      context: .
      dockerfile: ./packages/webhook-listener/Dockerfile.simple
      cache_from:
        - rtb-ai-hub-webhook-listener:latest
    container_name: rtb-webhook-listener
    volumes:
      - pnpm-cache:/root/.local/share/pnpm/store
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      WEBHOOK_PORT: 4000
      REDIS_HOST: redis
      REDIS_PORT: 6379
      JWT_SECRET: ${JWT_SECRET}
    ports:
      - '${WEBHOOK_PORT:-4000}:4000'
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - rtb-network
    healthcheck:
      test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost:4000/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  dashboard:
    build:
      context: ./packages/dashboard
      dockerfile: Dockerfile
      cache_from:
        - rtb-ai-hub-dashboard:latest
    container_name: rtb-dashboard
    volumes:
      - pnpm-cache:/root/.local/share/pnpm/store
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      VITE_API_URL: http://localhost:4000
    ports:
      - '${DASHBOARD_PORT:-3000}:80'
    depends_on:
      webhook-listener:
        condition: service_healthy
    networks:
      - rtb-network
    healthcheck:
      test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost:80/']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  openclaw-gateway:
    build:
      context: ./infrastructure/openclaw
      dockerfile: Dockerfile
    container_name: rtb-openclaw-gateway
    volumes:
      - ./infrastructure/openclaw/skills:/home/node/.openclaw/workspace/skills:ro
      - openclaw-state:/home/node/.openclaw
    environment:
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      SLACK_BOT_TOKEN: ${SLACK_BOT_TOKEN:-}
      SLACK_APP_TOKEN: ${SLACK_APP_TOKEN:-}
      OPENCLAW_HOOKS_ENABLED: 'true'
      OPENCLAW_HOOKS_TOKEN: ${OPENCLAW_HOOKS_TOKEN:-}
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_HOOKS_TOKEN:-}
      RTB_API_URL: http://host.docker.internal:4000
      RTB_API_TOKEN: ${OPENCLAW_HOOKS_TOKEN:-}
      DASHBOARD_URL: ${DASHBOARD_URL:-http://localhost:3000}
      NODE_TLS_REJECT_UNAUTHORIZED: '0'
      ATLASSIAN_SITE_NAME: ${ATLASSIAN_SITE_NAME:-rsquare}
      ATLASSIAN_USER_EMAIL: ${JIRA_EMAIL:-}
      ATLASSIAN_API_TOKEN: ${JIRA_API_TOKEN:-}
    ports:
      - '${OPENCLAW_PORT:-18789}:18789'
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - rtb-network
    healthcheck:
      test: ['CMD', 'curl', '-sf', 'http://localhost:18789/']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    profiles:
      - openclaw

  opencode-cli:
    image: ghcr.io/opencode-ai/opencode:latest
    container_name: rtb-opencode-cli
    volumes:
      - ./infrastructure/opencode:/root/.config/opencode:ro
      - opencode-data:/root/.opencode/data
    environment:
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
    ports:
      - '4096:4096'
    networks:
      - rtb-network
    command: ['opencode', 'serve', '--port', '4096', '--host', '0.0.0.0']
    healthcheck:
      test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost:4096/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    profiles:
      - opencode

  opencode-server:
    build:
      context: ./services/opencode-server
      dockerfile: Dockerfile
    container_name: rtb-opencode-server
    environment:
      PORT: 3333
      NODE_ENV: ${NODE_ENV:-development}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      OPENCODE_CLI_URL: http://opencode-cli:4096
    ports:
      - '3333:3333'
    depends_on:
      opencode-cli:
        condition: service_healthy
    networks:
      - rtb-network
    healthcheck:
      test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost:3333/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    profiles:
      - opencode

networks:
  rtb-network:
    driver: bridge

volumes:
  postgres-data:
  redis-data:
  pnpm-cache:
  openclaw-state:
  opencode-data:
